package top.yaotutu.deskmate.presentation.screen

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Arrangement
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.Row
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.layout.size
import androidx.compose.material3.Slider
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableFloatStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.TransformOrigin
import androidx.compose.ui.graphics.graphicsLayer
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.lifecycle.viewmodel.compose.viewModel
import top.yaotutu.deskmate.data.model.ConfigLoadResult
import top.yaotutu.deskmate.data.repository.LayoutConfigRepository
import top.yaotutu.deskmate.presentation.component.base.ProvideTileGrid
import top.yaotutu.deskmate.presentation.component.base.TileGrid
import top.yaotutu.deskmate.presentation.component.base.TileGridContainer
import top.yaotutu.deskmate.presentation.component.factory.TileFactory
import top.yaotutu.deskmate.presentation.component.layout.GridAreaLayout
import top.yaotutu.deskmate.presentation.theme.LocalScaleRatio
import top.yaotutu.deskmate.presentation.theme.MetroScaleSystem
import top.yaotutu.deskmate.presentation.theme.ProvideScaleRatio
import top.yaotutu.deskmate.presentation.viewmodel.DashboardViewModel
import kotlin.math.roundToInt

/**
 * 缩放测试页面
 *
 * 用于测试和验证容器级全局缩放系统（Metro Scale System）。
 * 提供动态调整缩放比例的功能，实时查看缩放效果。
 *
 * ## 功能
 *
 * 1. **缩放比例调节**：通过滑块动态调整缩放比例（0.5x ~ 2.0x）
 * 2. **实时预览**：实时显示缩放后的瓷砖效果
 * 3. **参数显示**：显示当前的 scaleRatio、baseCellSize 等关键参数
 * 4. **对比测试**：可以切换启用/禁用缩放系统进行对比
 *
 * ## 测试检查项
 *
 * - [ ] 字体大小随缩放系数等比变化
 * - [ ] 图标尺寸等比变化
 * - [ ] 内边距等比变化
 * - [ ] 圆角等比变化
 * - [ ] 动画效果正常
 * - [ ] 点击交互正常
 * - [ ] 文字清晰不模糊
 *
 * @since 2025-01-05
 */
@Composable
fun ScaleTestScreen(
    viewModel: DashboardViewModel = viewModel()
) {
    val uiState by viewModel.uiState.collectAsState()
    val context = LocalContext.current

    // 加载布局配置
    val configResult = remember {
        val repository = LayoutConfigRepository(context)
        repository.loadLayoutConfigForDevice()
    }

    val layoutConfig = when (configResult) {
        is ConfigLoadResult.Success -> configResult.config
        is ConfigLoadResult.Error -> configResult.fallbackConfig
            ?: LayoutConfigRepository(context).getSafeDefaultLayoutConfig()
    }

    // 可调节的缩放系数（0.5x ~ 2.0x）
    var customScaleRatio by remember { mutableFloatStateOf(1f) }
    var enableCustomScale by remember { mutableFloatStateOf(0f) }  // 0 = 自动, 1 = 手动

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(Color.Black)
    ) {
        // 顶部控制面板
        ScaleControlPanel(
            currentScale = customScaleRatio,
            onScaleChange = { customScaleRatio = it },
            enableCustomScale = enableCustomScale > 0.5f,
            onToggleCustomScale = { enableCustomScale = if (enableCustomScale > 0.5f) 0f else 1f },
            modifier = Modifier
                .fillMaxWidth()
                .background(Color(0xFF1E1E1E))
                .padding(16.dp)
        )

        Spacer(modifier = Modifier.height(8.dp))

        // 瓷砖展示区域
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(8.dp)
        ) {
            if (enableCustomScale > 0.5f) {
                // 使用自定义缩放
                CustomScaleTileContainer(
                    scaleRatio = customScaleRatio,
                    layoutConfig = layoutConfig,
                    uiState = uiState,
                    modifier = Modifier.fillMaxSize()
                )
            } else {
                // 使用自动缩放
                TileGridContainer(
                    modifier = Modifier.fillMaxSize(),
                    gridRows = layoutConfig.rows
                ) { baseCellSize, fixedGap, columns, screenHeight ->
                    ProvideTileGrid(baseCellSize, fixedGap, columns) {
                        GridAreaLayout(
                            config = layoutConfig,
                            baseCellSize = baseCellSize,
                            dynamicGap = fixedGap
                        ) { config, index ->
                            TileFactory.CreateTile(config, uiState, index)
                        }
                    }
                }
            }
        }
    }
}

/**
 * 自定义缩放容器
 */
@Composable
fun CustomScaleTileContainer(
    scaleRatio: Float,
    layoutConfig: top.yaotutu.deskmate.data.model.LayoutConfig,
    uiState: top.yaotutu.deskmate.presentation.viewmodel.DashboardUiState,
    modifier: Modifier = Modifier
) {
    androidx.compose.foundation.layout.BoxWithConstraints(modifier = modifier) {
        val screenWidth = maxWidth
        val screenHeight = maxHeight

        // 使用基准 baseCellSize
        val baseBaseCellSize = MetroScaleSystem.BASE_CELL_SIZE.dp

        // 计算基准列数
        val baseColumns = TileGrid.calculateColumns(screenWidth / scaleRatio, baseBaseCellSize)

        // 固定间距
        val fixedGap = TileGrid.getFixedGap()

        // 计算缩放后的逻辑尺寸
        val scaledWidth = MetroScaleSystem.calculateScaledSize(screenWidth, scaleRatio)
        val scaledHeight = MetroScaleSystem.calculateScaledSize(screenHeight, scaleRatio)

        // 应用容器级缩放
        ProvideScaleRatio(scaleRatio) {
            Box(
                modifier = Modifier
                    .size(scaledWidth, scaledHeight)
                    .graphicsLayer {
                        this.scaleX = scaleRatio
                        this.scaleY = scaleRatio
                        this.transformOrigin = TransformOrigin(0f, 0f)
                    }
            ) {
                ProvideTileGrid(baseBaseCellSize, fixedGap, baseColumns) {
                    GridAreaLayout(
                        config = layoutConfig,
                        baseCellSize = baseBaseCellSize,
                        dynamicGap = fixedGap
                    ) { config, index ->
                        TileFactory.CreateTile(config, uiState, index)
                    }
                }
            }
        }
    }
}

/**
 * 缩放控制面板
 */
@Composable
fun ScaleControlPanel(
    currentScale: Float,
    onScaleChange: (Float) -> Unit,
    enableCustomScale: Boolean,
    onToggleCustomScale: () -> Unit,
    modifier: Modifier = Modifier
) {
    val currentScaleRatio = LocalScaleRatio.current

    Column(modifier = modifier) {
        // 标题
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "缩放测试 (Scale Test)",
                fontSize = 20.sp,
                fontWeight = FontWeight.Bold,
                color = Color.White
            )

            // 切换按钮
            Text(
                text = if (enableCustomScale) "手动缩放" else "自动缩放",
                fontSize = 14.sp,
                color = if (enableCustomScale) Color(0xFF00D9FF) else Color(0xFFFF9800),
                modifier = Modifier
                    .background(Color(0xFF333333))
                    .clickable { onToggleCustomScale() }
                    .padding(horizontal = 16.dp, vertical = 8.dp)
            )
        }

        Spacer(modifier = Modifier.height(12.dp))

        // 参数显示
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceBetween
        ) {
            ParameterDisplay(
                label = if (enableCustomScale) "手动缩放" else "自动缩放",
                value = String.format("%.2fx", if (enableCustomScale) currentScale else currentScaleRatio)
            )
            ParameterDisplay(
                label = "基准尺寸",
                value = "${MetroScaleSystem.BASE_CELL_SIZE.toInt()}dp"
            )
            ParameterDisplay(
                label = "缩放状态",
                value = if (enableCustomScale) "手动" else "自动"
            )
        }

        if (enableCustomScale) {
            Spacer(modifier = Modifier.height(16.dp))

            // 缩放滑块
            Column {
                Text(
                    text = "调整缩放比例：${(currentScale * 100).roundToInt()}%",
                    fontSize = 14.sp,
                    color = Color.White.copy(alpha = 0.9f)
                )

                Spacer(modifier = Modifier.height(8.dp))

                Slider(
                    value = currentScale,
                    onValueChange = onScaleChange,
                    valueRange = 0.5f..2.0f,
                    modifier = Modifier.fillMaxWidth()
                )

                // 预设按钮
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween
                ) {
                    PresetButton("50%", 0.5f, onScaleChange)
                    PresetButton("75%", 0.75f, onScaleChange)
                    PresetButton("100%", 1.0f, onScaleChange)
                    PresetButton("125%", 1.25f, onScaleChange)
                    PresetButton("150%", 1.5f, onScaleChange)
                    PresetButton("200%", 2.0f, onScaleChange)
                }
            }
        }
    }
}

/**
 * 参数显示组件
 */
@Composable
fun ParameterDisplay(label: String, value: String) {
    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Text(
            text = label,
            fontSize = 12.sp,
            color = Color.White.copy(alpha = 0.7f)
        )
        Spacer(modifier = Modifier.height(4.dp))
        Text(
            text = value,
            fontSize = 16.sp,
            fontWeight = FontWeight.Bold,
            color = Color(0xFF00D9FF)
        )
    }
}

/**
 * 预设按钮
 */
@Composable
fun PresetButton(
    label: String,
    scale: Float,
    onClick: (Float) -> Unit
) {
    Box(
        modifier = Modifier
            .size(width = 52.dp, height = 32.dp)
            .background(Color(0xFF333333))
            .clickable { onClick(scale) }
            .padding(4.dp),
        contentAlignment = Alignment.Center
    ) {
        Text(
            text = label,
            fontSize = 12.sp,
            color = Color.White
        )
    }
}
